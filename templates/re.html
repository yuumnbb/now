<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›å¾©ãƒ—ãƒ­ã‚°ãƒ©ãƒ  - å†ã‚¹ã‚¿ãƒ¼ãƒˆè¨ºæ–­</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
  <style>
    :root {
      --primary-color: #4a90e2;
      --bg-color: #f4f7f6;
      --card-bg: #ffffff;
      --text-main: #333;
      --accent-color: #2ecc71;
      --warning-color: #f39c12;
    }

    body {
      background-color: var(--bg-color);
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 40px 20px;
      margin: 0;
    }

    .container {
      width: 100%;
      max-width: 650px;
      background: var(--card-bg);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .step { display: none; }
    .step.active { display: block; animation: fadeIn 0.4s ease-out; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    h1 { text-align: center; color: var(--primary-color); margin-bottom: 30px; }
    h2 { color: var(--primary-color); margin-bottom: 20px; font-size: 1.3rem; border-bottom: 2px solid #f0f4f8; padding-bottom: 10px; }
    p { color: #666; line-height: 1.6; margin-bottom: 25px; }

    .option-list { display: grid; gap: 12px; margin: 20px 0; }
    .option-item {
      padding: 18px 20px;
      border: 2px solid #eee;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .option-item:hover { border-color: var(--primary-color); background-color: #f0f7ff; }
    .option-item.selected { border-color: var(--primary-color); background-color: var(--primary-color); color: white; }

    .ai-proposal-container {
      background-color: #fdfaf0;
      border-left: 5px solid var(--warning-color);
      padding: 25px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .ai-proposal-content {
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.7;
      color: #444;
    }

    label { display: block; font-weight: bold; margin: 25px 0 8px; color: var(--primary-color); }
    textarea {
      width: 100%;
      height: 120px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
      resize: none;
      background-color: #fafafa;
    }
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      background-color: #fff;
    }

    .btn-group { display: flex; justify-content: space-between; margin-top: 30px; }
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: opacity 0.2s, transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-next { background-color: var(--primary-color); color: white; }
    .btn-prev { background-color: #eee; color: #666; }

    #loading { text-align: center; display: none; padding: 50px 0; }
    .spinner {
      border: 4px solid rgba(0,0,0,0.1);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border-left-color: var(--primary-color);
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .final-advice-box {
      background-color: #e8f5e9;
      border: 1px solid #c8e6c9;
      padding: 25px;
      border-radius: 12px;
      margin-top: 20px;
    }

    .checkbox-group {
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>å›å¾©ãƒ—ãƒ­ã‚°ãƒ©ãƒ </h1>

  <!-- Step 1: çŠ¶æ³è¨ºæ–­ -->
  <div class="step active" id="step1">
    <h2>Q1. å­¦ç¿’ãŒæ­¢ã¾ã£ãŸçŠ¶æ³ã¯ï¼Ÿ</h2>
    <p>å†é–‹ã®ãŸã‚ã®ç¬¬ä¸€æ­©ã§ã™ã€‚å½“ã¦ã¯ã¾ã‚‹ã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
    <div class="option-list">
      <div class="option-item" onclick="select('q1', 'è¨˜éŒ²å¿˜ã‚Œï¼ˆå­¦ç¿’ã¯ã—ãŸãŒå…¥åŠ›ã®ã¿å¿˜ã‚ŒãŸï¼‰')">ğŸ“ è¨˜éŒ²ã‚’å¿˜ã‚ŒãŸã ã‘</div>
      <div class="option-item" onclick="select('q1', 'ä¸å¯æŠ—åŠ›ï¼ˆæ€¥ç”¨ãƒ»ä½“èª¿ä¸è‰¯ç­‰ã§ã§ããªã‹ã£ãŸï¼‰')">ğŸŒªï¸ ä¸å¯æŠ—åŠ›ã«ã‚ˆã‚‹ä¸­æ–­</div>
      <div class="option-item" onclick="select('q1', 'å­¦ç¿’å¿˜ã‚Œï¼ˆå­¦ç¿’ã™ã‚‹ã“ã¨è‡ªä½“ã‚’å¿˜ã‚Œã¦ã„ãŸï¼‰')">â“ å­¦ç¿’ã™ã‚‹ã“ã¨è‡ªä½“ã‚’å¿˜ã‚ŒãŸ</div>
    </div>
    <div class="btn-group">
      <div></div>
      <button class="btn btn-next" onclick="go(2)">æ¬¡ã¸é€²ã‚€</button>
    </div>
  </div>

  <!-- Step 2: ã‚¢ãƒ³ã‚«ãƒ¼ã®è¨ºæ–­ -->
  <div class="step" id="step2">
    <h2>Q2. ãã£ã‹ã‘ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼‰ã®çŠ¶æ…‹ã¯ï¼Ÿ</h2>
    <p>ç¿’æ…£ã®å¼•ãé‡‘ãŒã†ã¾ãæ©Ÿèƒ½ã—ã¦ã„ãŸã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</p>
    <div class="option-list">
      <div class="option-item" onclick="select('q2', 'ã‚¢ãƒ³ã‚«ãƒ¼è‡ªä½“ã‚’å¿˜ã‚Œã¦ã„ãŸ')">ãã£ã‹ã‘è‡ªä½“ã‚’å¿˜ã‚Œã¦ã„ãŸ</div>
      <div class="option-item" onclick="select('q2', 'ãã£ã‹ã‘ã¯è¡Œã£ãŸãŒå­¦ç¿’ã«ç§»ã‚Œãªã‹ã£ãŸ')">ãã£ã‹ã‘ã¯ã—ãŸãŒæ¬¡ã«é€²ã‚ãªã‹ã£ãŸ</div>
      <div class="option-item" onclick="select('q2', 'ç‰¹ã«å•é¡Œãªã‹ã£ãŸ')">ç‰¹ã«å•é¡Œãªããã£ã‹ã‘ã¯è¡ŒãˆãŸ</div>
    </div>
    <div class="btn-group">
      <button class="btn btn-prev" onclick="go(1)">æˆ»ã‚‹</button>
      <button class="btn btn-next" onclick="go(3)">æ¬¡ã¸é€²ã‚€</button>
    </div>
  </div>

  <!-- Step 3: è² æ‹…æ„Ÿã®è¨ºæ–­ -->
  <div class="step" id="step3">
    <h2>Q3. ä»Šã®ã€Œå°ã•ãªè¡Œå‹•ã€ã®è² æ‹…æ„Ÿã¯ï¼Ÿ</h2>
    <p>ç›®æ¨™ã®é«˜ã•ãŒä»Šã®è‡ªåˆ†ã«åˆã£ã¦ã„ã‚‹ã‹è¨ºæ–­ã—ã¾ã™ã€‚</p>
    <div class="option-list">
      <div class="option-item" onclick="select('q3', 'æ­£ç›´ã€ä»Šã®è¨­å®šã§ã‚‚å°‘ã—é¢å€’ã«æ„Ÿã˜ã‚‹')">ä»Šã®è¨­å®šã§ã‚‚å°‘ã—é¢å€’ã«æ„Ÿã˜ã‚‹</div>
      <div class="option-item" onclick="select('q3', 'å†…å®¹ã¯ç°¡å˜ã ãŒæ™‚é–“ãŒä½œã‚Œãªã‹ã£ãŸ')">å†…å®¹ã¯ç°¡å˜ã ãŒæ™‚é–“ãŒãªã‹ã£ãŸ</div>
      <div class="option-item" onclick="select('q3', 'ä»Šã®ã¾ã¾ã§é©åˆ‡ã ã¨æ€ã†')">ä»Šã®ã¾ã¾ã§é©åˆ‡ã ã¨æ€ã†</div>
    </div>
    <div class="btn-group">
      <button class="btn btn-prev" onclick="go(2)">æˆ»ã‚‹</button>
      <button class="btn btn-next" onclick="getProposal()">AIã®ææ¡ˆã‚’å—ã‘ã‚‹</button>
    </div>
  </div>

  <!-- Step 4: AIã®ææ¡ˆã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€çµ‚å…¥åŠ› -->
  <div class="step" id="step4">
    <h2>AIã«ã‚ˆã‚‹åˆ†æã¨å†é–‹ã¸ã®ææ¡ˆ</h2>
    <div class="ai-proposal-container">
      <div id="aiProposalText" class="ai-proposal-content">åˆ†æä¸­...</div>
    </div>
    
    <p>AIã®ææ¡ˆã‚’å‚è€ƒã«ã€ä»Šå›ã®å¤±æ•—ã‚’æˆé•·ã«å¤‰ãˆã‚‹ãŸã‚ã®è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ã‚‡ã†ã€‚</p>
    
    <label for="reason">ä»Šå›ã®æœ¬å½“ã®åŸå› ã¯ä½•ã ã£ãŸã¨æ€ã„ã¾ã™ã‹ï¼Ÿ</label>
    <textarea id="reason" placeholder="ä¾‹ï¼šä»•äº‹ã®ç–²ã‚Œã‚’è€ƒæ…®ã›ãšã€å¤œã«é›£ã—ã„å†…å®¹ã‚’è¨­å®šã—ã™ãã¦ã„ãŸã€‚"></textarea>

    <label for="improvement">æ˜æ—¥ã‹ã‚‰ã©ã®ã‚ˆã†ã«æ”¹å–„ã—ã¾ã™ã‹ï¼Ÿ</label>
    <textarea id="improvement" placeholder="ä¾‹ï¼šç–²ã‚Œã¦ã„ã‚‹æ™‚ã¯ã€æœ¬ã‚’é–‹ãã ã‘ã€ã«ãƒãƒ¼ãƒ‰ãƒ«ã‚’ä¸‹ã’ã‚‹ã€‚ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’10åˆ†æ—©ã‚ã‚‹ã€‚"></textarea>

    <div class="checkbox-group">
      <input type="checkbox" id="is_shared" checked>
      <label for="is_shared" style="display:inline; margin:0; font-weight:normal; color:#666;">ã“ã®æŒ¯ã‚Šè¿”ã‚Šã‚’ã¿ã‚“ãªã«å…±æœ‰ã—ã¦åŠ±ã¾ã—åˆã†</label>
    </div>

    <div class="btn-group">
      <button class="btn btn-prev" onclick="go(3)">æˆ»ã‚‹</button>
      <button class="btn btn-next" onclick="saveFinal()">æœ€çµ‚è¨ºæ–­ã‚’ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>

  <!-- Step 5: å®Œäº†ã¨æœ€çµ‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
  <div class="step" id="step5">
    <h2>å†ã‚¹ã‚¿ãƒ¼ãƒˆã®æº–å‚™ãŒã§ãã¾ã—ãŸï¼</h2>
    <div id="finalAdviceContent" class="final-advice-box"></div>
    <p style="margin-top: 25px; font-size: 0.9rem; text-align: center;">
      ã€Œå°ã•ãªè¡Œå‹•ã€ã‹ã‚‰ã€ã¾ãŸä¸€æ­©ãšã¤å§‹ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
    </p>
    <div class="btn-group">
      <div></div>
      <button class="btn btn-next" onclick="location.href='/mypage'">ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
  <div id="loading">
    <div class="spinner"></div>
    <p id="loadingText">AIãŒã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™...</p>
  </div>
</div>

<script>
  let answers = { q1: '', q2: '', q3: '' };

  // é¸æŠè‚¢ã®ç®¡ç†
  function select(q, val) {
    answers[q] = val;
    const items = event.currentTarget.parentElement.querySelectorAll('.option-item');
    items.forEach(i => i.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
  }

  // ã‚¹ãƒ†ãƒƒãƒ—ç§»å‹•
  function go(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + n).classList.add('active');
    window.scrollTo(0, 0);
  }

  // 1. AIã‹ã‚‰ã®ææ¡ˆï¼ˆåˆ†æã¨2ã€œ3æ¡ˆï¼‰ã‚’å–å¾—
  async function getProposal() {
    if(!answers.q1 || !answers.q2 || !answers.q3) {
      alert("å…¨ã¦ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    document.getElementById('step3').classList.remove('active');
    document.getElementById('loading').style.display = 'block';

    try {
      const res = await fetch('/recovery', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mode: 'propose', ...answers })
      });
      const data = await res.json();
      
      document.getElementById('aiProposalText').innerText = data.proposal;
      document.getElementById('loading').style.display = 'none';
      go(4);
    } catch (err) {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      document.getElementById('loading').style.display = 'none';
      go(3);
    }
  }

  // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ä¿å­˜ã—ã€æœ€çµ‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
  async function saveFinal() {
    const r = document.getElementById('reason').value.trim();
    const i = document.getElementById('improvement').value.trim();
    
    if(!r || !i) {
      alert("åŸå› ã¨å¯¾ç­–ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    document.getElementById('step4').classList.remove('active');
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loadingText').innerText = "æœ€çµ‚çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆä¸­...";

    try {
      const res = await fetch('/recovery', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
          mode: 'save', 
          reason: r, 
          improvement: i,
          is_shared: document.getElementById('is_shared').checked,
          ...answers 
        })
      });
      const data = await res.json();
      
      if(data.success) {
        document.getElementById('finalAdviceContent').innerHTML = 
          "<strong>âœ¨ AIã‹ã‚‰ã®æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong><br><br>" + 
          data.advice.replace(/\n/g, "<br>");
        document.getElementById('loading').style.display = 'none';
        go(5);
      } else {
        throw new Error();
      }
    } catch (err) {
      alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      document.getElementById('loading').style.display = 'none';
      go(4);
    }
  }
</script>

</body>
</html>